# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main]

name: Deploy-Site
jobs:
  deploy:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    permissions:
      contents: 'read'
      id-token: 'write'
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-20.04,   r: '4.3.2'}

    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo curl -LO https://quarto.org/download/latest/quarto-linux-amd64.deb
          sudo apt-get install gdebi-core
          sudo gdebi -n quarto-linux-amd64.deb

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          use-public-rspm: true
          Ncpus: 2

      - name: Install R Dependencies
        run: |
          install.packages(c("quarto", "fs"))
        shell: Rscript {0}

      - name: Render Quarter Website
        run: |
          quarto::quarto_render(".", as_job = FALSE, output_format = "html")
          fs::dir_copy(path = "_site", new_path = "blog")
        shell: Rscript {0}

      - name: Upload Website to Host
        uses: appleboy/scp-action@v0.1.4
        with:
          host: rdata.blog
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: blog/*
          target: /var/www/

      - name: Reload Apache on Host
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: rdata.blog
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl reload apache2
